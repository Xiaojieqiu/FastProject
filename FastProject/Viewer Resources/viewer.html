<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>FastProject Viewer</title>
    <script type="text/javascript" src="jquery-2.1.4.min.js"></script>
    <script type="text/javascript" src="d3.min.js"></script>
    <script type="text/javascript" src="FP_data.jsdata"></script>
    <script type="text/javascript" src="ColorScatter.js"></script>
    <script type="text/javascript" src="HeatMap.js"></script>

    <!-- Bootstrap Stuff -->
    <link rel="stylesheet" href="bootstrap.css">
    <link rel="stylesheet" href="bootstrap-theme.css">
    <script src="bootstrap.min.js"></script>

    <script type="text/javascript">

        var global_status = {};
        global_status.plotted_projection = -1;
        global_status.plotted_signature = -1;
        global_status.sorted_column = -1;
        global_status.signature_filter = "";

        var global_options = {};
        var global_scatter = {};
        var global_heatmap = {};


        window.onload = function()
        {
            global_scatter = new ColorScatter("#scatter_div");
            global_heatmap = new HeatMap("#heatmap_div");
            global_scatter.hovered_links.push(global_heatmap);
            global_heatmap.hovered_links.push(global_scatter);
            updateTable();
            $("#probability_checkbox").change(updateTable);
            $("#pca_checkbox").change(updateTable);

            full_output = (typeof FP_Expression !== "undefined") &
                    (typeof FP_Probability !== "undefined") &
                    (typeof FP_ExpressionPC !== "undefined") &
                    (typeof FP_ProbabilityPC !== "undefined");

            global_options.full_output = full_output;
            if(!global_options.full_output){
                $("#data_options_div").hide();
            }
        };

        function updateTable()
        {
            var data = getDataContext();
            $('#sig_filt_input').detach(); //Save this for when the table is rebuilt.
            $('#table_div').children('table').remove();
            createTableFromData(data.SigProjMatrix_p, data.ProjectionKeys, data.SignatureKeys);
            $('#sig_filt_input').change();
            sortByColumn();
            drawChart();
            drawHeat();
        }

        function getDataContext()
        {
            if(global_options.full_output) {
                var probability = $('#probability_checkbox').is(":checked");
                var pca = $('#pca_checkbox').is(":checked");
                if (!probability && !pca) {
                    return FP_Expression;
                }
                if (!probability && pca) {
                    return FP_ExpressionPC;
                }
                if (probability && !pca) {
                    return FP_Probability;
                }
                if (probability && pca) {
                    return FP_ProbabilityPC;
                }
            }
            else{
                if(typeof FP_Expression !== "undefined") return FP_Expression;
                if(typeof FP_ExpressionPC !== "undefined") return FP_ExpressionPC;
                if(typeof FP_Probability !== "undefined") return FP_Probability;
                if(typeof FP_ProbabilityPC !== "undefined") return FP_ProbabilityPC;
            }
        }


        Array.prototype.argSort = function()
        {
            out = new Array(this.length);
            for(var i = 0; i < out.length; i++) out[i] = i;
            var that = this;
            out.sort(function(a,b){return that[a] - that[b];});
            return out;
        };

        function transpose(inputMatrix){
            var IN_ROWS = inputMatrix.length;
            var IN_COLS = inputMatrix[0].length;

            var outputMatrix = new Array(IN_COLS);

            //allocate arrays
            for(var i = 0; i < IN_COLS; i++)
            {
                outputMatrix[i] = new Array(IN_ROWS);
            }

            for(var i = 0; i < IN_ROWS; i++)
            {
                for (var j = 0; j < IN_COLS; j++)
                {
                    outputMatrix[j][i] = inputMatrix[i][j];
                }
            }

            return outputMatrix;
        }

        function median(inputArray){
            var sorted_array = inputArray.slice().sort();
            if(sorted_array.length%2 == 0){
                center_i = (sorted_array.length-1)/2;
                med_val = sorted_array[center_i];
            }
            else{
                center_i = (sorted_array.length-1)/2;
                med_val = sorted_array[center_i-1]/2 + sorted_array[center_i]/2;
            }
            return med_val;
        }

        function sortByColumn()
        {
            var j = global_status.sorted_column;
            if(j == -1){return;}
            var table = $('#table_div').children('table');

            var sortFunction = function(a,b){
                var a_val = $(a).children("td").eq(j+1).data("data_val");
                var b_val = $(b).children("td").eq(j+1).data("data_val");
                return a_val - b_val;
            };

            var unsorted_rows = table.children('tbody').children('tr:not(:first)');
            var sorted_rows = unsorted_rows.sort(sortFunction);

            unsorted_rows.detach();
            table.children('tbody').append(sorted_rows);

            $('#table_div').find('tr').removeClass('altRow')
                    .not('.hidden').filter(':odd').addClass('altRow');

        }

        function tableClickFunction(event)
        {
            var cell = $(event.target);
            global_status.plotted_signature  = cell.data("row_num");
            global_status.plotted_projection = cell.data("col_num");
            drawChart();
            drawHeat();
        }

        function drawChart() {
            i = global_status.plotted_signature;
            j = global_status.plotted_projection;

            if(i > -1 && j > -1){
                data = getDataContext();

                sig_key = data.SignatureKeys[i];
                proj_key = data.ProjectionKeys[j];

                proj = data.Projections[proj_key];
                sig = data.SigScores[sig_key];

                xcoords = proj[0];
                ycoords = proj[1];
                //Zip up the data into a new points object
                points = [];
                for(i = 0; i<xcoords.length; i++)
                {
                    points.push([xcoords[i], ycoords[i], sig[i]]);
                }
            }
            else{
                points = [];
            }

            global_scatter.setData(points);
        }

        function drawHeat(){
            i = global_status.plotted_signature;
            if( i > -1)
            {
                sig_key = data.SignatureKeys[i];
                sig = FP_Signatures[sig_key]
                genes = sig.Genes;

                //Construct data matrix
                //Look up gene indices
                gene_indices = [];
                for(j = 0; j < genes.length; j++)
                {
                    gene_index = FP_ExpressionMatrix.gene_labels.indexOf(genes[j]);
                    if(gene_index > -1) //Some genes are in signature, but not in data
                    {
                        gene_indices.push(gene_index);
                    }
                }

                dataMat = gene_indices.map(function(e,i){
                    return FP_ExpressionMatrix.data[e];
                });

                global_heatmap.setData(dataMat);

            }
        }

        function floatToColor(value, cmin, cmax, cmap)
        {
            norm_val = (value - cmin) / (cmax-cmin); //Normalize to 0-1
            norm_val = 1-norm_val;  //Invert

            //Old color values
            /*blue = 4*(0.75-norm_val);
             red = 4*(norm_val -.25);
             green = 4*Math.abs(norm_val - 0.5)-1;*/

            var blue = 1-1*norm_val;
            var red = norm_val;
            var green = 1-Math.abs(norm_val - 0.5)*2;

            if(blue < 0) blue = 0;
            if(blue > 1) blue = 1;
            if(green < 0) green = 0;
            if(green > 1) green = 1;
            if(red < 0) red = 0;
            if(red > 1) red = 1;

            //color maps
            if(cmap == "light") {
                blue = (blue / 2) + 0.5;
                red = (red / 2) + 0.5;
                green = (green / 2) + 0.5;
            }

            blue = Math.round(blue*255);
            red = Math.round(red*255);
            green = Math.round(green*255);

            //No good zero padding in JS?
            var rpad = (red < 16) ? "0" : "";
            var gpad = (green < 16) ? "0" : "";
            var bpad = (blue < 16) ? "0" : "";

            return "#" + rpad + red.toString(16) + gpad + green.toString(16) + bpad + blue.toString(16);
        }

        function createTableFromData(data_matrix, col_labels, row_labels)
        {
            var rowMin = function(row){return Math.min.apply(Math, row);};
            var rowMax = function(row){return Math.max.apply(Math, row);};
            var matrixMin = function(matrix){
                return rowMin(matrix.map(rowMin));
            };
            var matrixMax = function(matrix){
                return rowMax(matrix.map(rowMax));
            };

            var tbl = document.createElement("table");
            var tbody = document.createElement("tbody");

            //Create column headers
            function generateColSortFcn(col_num)
            {
                return function(){global_status.sorted_column=col_num; sortByColumn();};
            }
            var tr = document.createElement("tr");
            var th = document.createElement("th");

            //Create filter signature box
            var filterSig = $('<input/>').attr({type: 'text', id: 'sig_filt_input', placeholder: 'Filter Signatures...'});
            filterSig.on('change textInput input', function(){
                global_status.signature_filter = this.value;
                var val = this.value.toLowerCase();
                $('#table_div').find('tr').removeClass('hidden')
                        .filter(function(i, element){
                            if(i == 0){return false;}
                            sig_text = $(element).children('td').first().html().toLowerCase();
                            return sig_text.indexOf(val) == -1;
                        }).addClass('hidden');
                $('#table_div').find('tr').removeClass('altRow')
                        .not('.hidden').filter(':odd').addClass('altRow');

            });
            filterSig.val(global_status.signature_filter);
            $(th).append(filterSig);

            tr.appendChild(th); //Empty upper left cell
            for(var j=0; j < col_labels.length; j++){
                th = document.createElement("th");
                th.appendChild(document.createTextNode(col_labels[j]));
                $(th).click(generateColSortFcn(j));
                tr.appendChild(th);
            }
            tbody.appendChild(tr);

            //Create color matrix
            dmT = transpose(data_matrix);
            for(i = 0; i < dmT.length; i++){
                dmT[i] = dmT[i].argSort().argSort();
            }
            color_matrix = transpose(dmT);

            for(var i=0; i < data_matrix.length; i++)
            {
                tr = document.createElement("tr");

                //Create row label
                var label_td = document.createElement("td");
                label_td.appendChild(document.createTextNode(row_labels[i]));
                $(label_td).on("click", function(e){createSigModal($(this).html())});
                tr.appendChild(label_td);

                for(var j = 0; j < data_matrix[i].length; j++)
                {
                    var td = document.createElement("td");
                    var td_text;
                    if(data_matrix[i][j] > -20)
                    {
                        td_text = data_matrix[i][j].toString();
                    }
                    else
                    {
                        td_text = "< -20";
                    }
                    td.appendChild(document.createTextNode(td_text));
                    tr.appendChild(td);
                    td = $(td);
                    td.data("row_num", i);
                    td.data("col_num", j);
                    td.data("data_val", data_matrix[i][j]);
                    td.click(tableClickFunction);
                    td.css("background-color", floatToColor(color_matrix[i][j], 0, data_matrix.length,"light"));
                }
                tbody.appendChild(tr);
            }
            tbl.appendChild(tbody);

            var tbldiv = document.getElementById("table_div");
            tbldiv.appendChild(tbl);
        }

        function createSigModal(signature_label){
            sig_obj = FP_Signatures[signature_label];
            sig_data = [];
            for(i = 0; i < sig_obj.Genes.length; i++)
            {
                sig_data.push({'Gene': sig_obj.Genes[i], 'Sign': sig_obj.Signs[i]});
            }
            sigModal = $('#signatureModal');
            sigModal.find('h4').text(signature_label);
            tableRows = d3.select('#signatureModal').select('tbody').selectAll('tr')
                    .data(sig_data);
            tableRows.enter().append('tr');
            tableRows.exit().remove();

            tableCells = tableRows.selectAll('td').data(function(d){return [d.Gene, d.Sign];});
            tableCells.enter().append('td');
            tableCells.text(function(d){console.log(d);return d;});

            tableCells.exit().remove();

            sigModal.modal();
        }

    </script>
    <style>
        html {
            height: 100%;
        }

        body {
            height: 100%;
            padding-top: 1px;
        }

        #table_div table{
            margin-right: 50px; /* So the table div accounts for angled labels */
        }

        #table_div table th:first-child{
            text-align:left;
        }

        #table_div table th:not(:first-child) {
            transform-origin: left center 0;
            transform: translate(15px,1em) rotate(-50deg);
        }

        #table_div table td:first-child{
            max-width:450px;
            width:450px;
            -ms-word-wrap: break-word;
            word-wrap: break-word;
            cursor: pointer;
        }

        .altRow{
            background-color: rgb(220,220,220);
        }

        #table_div table td:not(:first-child), table th:not(:first-child){
            text-align: center;
            width: 50px;
            max-width: 50px;
            cursor: pointer;
        }

        #table_div table td:not(:first-child){
            padding: 5px 0;
        }

        .hidden {
            display: none;
        }

        #table_div{
            padding-top: 40px;
            overflow: auto;
            position: absolute;
            top: 150px;
            bottom: 0px;
        }

        svg {
            font: 10px sans-serif;
            shape-rendering: crispEdges;
        }

        rect {
            fill: #ddd;
        }

        svg circle{
            fill-opacity: 0.7;
        }

        .axis path,
        .axis line {
            fill: none;
            stroke: #fff;
        }

        #scatter_div{
            float: right;
        }

        #heatmap_div{
            float: right;
            clear: both;
        }

        .point-hover{
            fill-opacity: 1.0;
            stroke: #444444;
        }

        .point-selected{
            stroke: yellow;
            stroke-width: 2px;
        }

        /* Style for hovered heatmap rows */
        .heatmap-hover {
           stroke: black;
            stroke-width: 1px;
        }

    </style>
</head>
<body>
<div class="modal fade" id="signatureModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="myModalLabel">Signature Info</h4>
            </div>
            <div class="modal-body">
                <table>
                    <thead>
                    <tr>
                        <th>Gene</th>
                        <th>Sign</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<h1>FastProject Viewer</h1>
<br>
<div id="data_options_div">
    <span>
        <label for="probability_checkbox">Probability Model?</label>
        <input id="probability_checkbox" type="checkbox">
    </span>
    <span>
        <label for="pca_checkbox">PCA Before Project?</label>
        <input id="pca_checkbox" type="checkbox">
    </span>
</div>
<br>
<div id="table_div" style="display:inline-block; float:left"></div>
<div id="scatter_div"></div>
<div id="heatmap_div"></div>
<input id="sig_filt_input" type="text" placeholder="Filter Signatures...">
</body>
</html>
